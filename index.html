<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>米哈游启动器图片、视频提取</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a more premium feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8">

    <!-- 1. Title Section -->
    <div class="text-center mb-10 w-full max-w-4xl">
        <h1
            class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 tracking-tight sm:text-5xl mb-2">
            米哈游启动器图片、视频提取
        </h1>
        <p class="text-lg text-gray-500">
            上传二进制文件，自动提取并预览其中的媒体资源链接
        </p>
    </div>

    <!-- 1.5 Instruction Section -->
    <div class="w-full max-w-4xl mb-6 bg-blue-50 border border-blue-100 rounded-xl p-5 shadow-sm">
        <div class="flex items-start mb-3">
            <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <h3 class="text-sm font-bold text-blue-800 mb-1">使用说明</h3>
                <p class="text-sm text-blue-700 leading-relaxed">
                    请复制下方路径，点击上传按钮，粘贴到地址栏并回车。然后选择该文件夹内的 <span
                        class="font-mono bg-blue-100 px-1 rounded text-blue-900">data_1</span> 文件。
                </p>
            </div>
        </div>

        <div class="flex items-center space-x-2 bg-white rounded-lg border border-blue-200 p-1 pl-3">
            <code class="flex-1 text-sm text-gray-600 font-mono break-all select-all"
                id="path-code">%USERPROFILE%\AppData\Roaming\miHoYo\HYP\1_1\fedata\Cache\Cache_Data</code>
            <button id="copy-btn"
                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-md transition-colors flex items-center shrink-0 shadow-sm active:transform active:scale-95">
                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3">
                    </path>
                </svg>
                复制路径
            </button>
        </div>
    </div>

    <!-- 2. Upload Section -->
    <div class="w-full max-w-4xl mb-8">
        <div class="flex flex-col items-center justify-center w-full">
            <label for="file-upload"
                class="flex flex-col items-center justify-center w-full h-48 border-2 border-blue-300 border-dashed rounded-2xl cursor-pointer bg-white hover:bg-blue-50 transition-all duration-300 shadow-sm hover:shadow-md group">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <svg class="w-10 h-10 mb-3 text-blue-400 group-hover:text-blue-600 transition-colors"
                        aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                    </svg>
                    <p class="mb-2 text-sm text-gray-500 group-hover:text-gray-700"><span
                            class="font-semibold">点击上传</span> data_1 文件</p>
                </div>
                <input id="file-upload" type="file" class="hidden" />
            </label>
        </div>
        <div id="status-msg" class="mt-4 text-center text-sm text-gray-500 hidden">正在处理...</div>
    </div>

    <!-- 2.5 Filter Section -->
    <div class="w-full max-w-4xl mb-6 flex justify-center space-x-6 hidden" id="filter-container">
        <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="filter-img"
                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" checked>
            <span class="ml-2 text-gray-700">图片 (jpg, png, webp)</span>
        </label>
        <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="filter-video"
                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" checked>
            <span class="ml-2 text-gray-700">视频 (webm)</span>
        </label>
        <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="filter-other"
                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
            <span class="ml-2 text-gray-700">其他 (json, gameConfig...)</span>
        </label>
    </div>

    <!-- 3. Results Table Section -->
    <div class="w-full max-w-6xl overflow-hidden rounded-xl shadow-lg border border-gray-200 bg-white hidden"
        id="result-container">

        <!-- Hint -->
        <div class="bg-blue-50 px-6 py-2 text-xs text-blue-600 border-b border-blue-100 text-center">
            Chrome 浏览器按住 Alt 键点击链接即可直接下载。
        </div>

        <!-- Top Pagination & Info -->
        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center justify-between">
            <div class="text-sm text-gray-500" id="count-display-top">
                共找到 0 个链接
            </div>
            <div class="flex items-center space-x-2">
                <button id="prev-btn-top"
                    class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    上一页
                </button>
                <span class="text-sm text-gray-700">
                    第 <span id="current-page-top" class="font-semibold">1</span> / <span id="total-pages-top"
                        class="font-semibold">1</span> 页
                </span>
                <button id="next-btn-top"
                    class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    下一页
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">
                            预览
                        </th>
                        <th scope="col"
                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            链接
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="result-body">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Bottom Pagination & Info -->
        <div class="bg-gray-50 px-6 py-3 border-t border-gray-200 flex items-center justify-between">
            <div class="text-sm text-gray-500" id="count-display-bottom">
                共找到 0 个链接
            </div>
            <div class="flex items-center space-x-2">
                <button id="prev-btn-bottom"
                    class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    上一页
                </button>
                <span class="text-sm text-gray-700">
                    第 <span id="current-page-bottom" class="font-semibold">1</span> / <span id="total-pages-bottom"
                        class="font-semibold">1</span> 页
                </span>
                <button id="next-btn-bottom"
                    class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    下一页
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full max-w-4xl mt-12 mb-6 text-center text-sm text-gray-500">
        <div class="flex justify-center space-x-6">
            <a href="https://github.com/iBobbyTS/HoYoPlayExtractor" target="_blank"
                class="hover:text-blue-600 transition-colors flex items-center">
                <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                        clip-rule="evenodd"></path>
                </svg>
                GitHub
            </a>
            <a href="https://space.bilibili.com/456858935" target="_blank"
                class="hover:text-blue-600 transition-colors flex items-center">
                <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path
                        d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267c.053-.071.116-.142.187-.213l3.467-3.253c.267-.249.573-.373.92-.373.347 0 .653.124.92.373l.027.027c.249.249.373.551.373.907 0 .355-.124.657-.373.906L17.813 4.653zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773H5.333zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373z">
                    </path>
                </svg>
                Bilibili
            </a>
        </div>
        <p class="mt-2 text-xs text-gray-400">Designed by iBobby</p>
    </footer>

    <script>
        const fileInput = document.getElementById('file-upload');
        const resultContainer = document.getElementById('result-container');
        const filterContainer = document.getElementById('filter-container');
        const resultBody = document.getElementById('result-body');
        const statusMsg = document.getElementById('status-msg');

        const filterImg = document.getElementById('filter-img');
        const filterVideo = document.getElementById('filter-video');
        const filterOther = document.getElementById('filter-other');

        const copyBtn = document.getElementById('copy-btn');
        const pathCode = document.getElementById('path-code');

        // Copy functionality
        if (copyBtn) {
            copyBtn.addEventListener('click', () => {
                const textToCopy = pathCode.textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = `<svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>已复制`;
                    copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('复制失败，请手动复制');
                });
            });
        }

        // Top Pagination Elements
        const prevBtnTop = document.getElementById('prev-btn-top');
        const nextBtnTop = document.getElementById('next-btn-top');
        const currentPageSpanTop = document.getElementById('current-page-top');
        const totalPagesSpanTop = document.getElementById('total-pages-top');
        const countDisplayTop = document.getElementById('count-display-top');

        // Bottom Pagination Elements
        const prevBtnBottom = document.getElementById('prev-btn-bottom');
        const nextBtnBottom = document.getElementById('next-btn-bottom');
        const currentPageSpanBottom = document.getElementById('current-page-bottom');
        const totalPagesSpanBottom = document.getElementById('total-pages-bottom');
        const countDisplayBottom = document.getElementById('count-display-bottom');

        // Supported extensions for preview and filtering
        const IMAGE_EXTS = ['jpg', 'jpeg', 'png', 'webp'];
        const VIDEO_EXTS = ['webm'];

        const ITEMS_PER_PAGE = 50;
        let allMatches = [];
        let filteredMatches = []; // Store filtered result for pagination
        let currentPage = 1;

        fileInput.addEventListener('change', handleFileSelect);

        // Add event listeners for filters
        [filterImg, filterVideo, filterOther].forEach(el => {
            el.addEventListener('change', () => {
                currentPage = 1; // Reset to first page on filter change
                applyFiltersAndRender();
            });
        });

        // Pagination listeners
        function goToPage(page) {
            const totalPages = Math.ceil(filteredMatches.length / ITEMS_PER_PAGE) || 1;
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderTablePage();

            // Scroll to top of result container
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        prevBtnTop.addEventListener('click', () => goToPage(currentPage - 1));
        nextBtnTop.addEventListener('click', () => goToPage(currentPage + 1));
        prevBtnBottom.addEventListener('click', () => goToPage(currentPage - 1));
        nextBtnBottom.addEventListener('click', () => goToPage(currentPage + 1));

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Reset UI
            resultContainer.classList.add('hidden');
            filterContainer.classList.add('hidden');
            resultBody.innerHTML = '';
            statusMsg.textContent = `正在读取文件: ${file.name}...`;
            statusMsg.classList.remove('hidden');

            const reader = new FileReader();

            reader.onload = function (e) {
                statusMsg.textContent = '正在解析链接...';
                setTimeout(() => {
                    const content = e.target.result;
                    processContent(content);
                }, 50);
            };

            reader.onerror = function () {
                statusMsg.textContent = '读取文件失败';
                statusMsg.classList.add('text-red-500');
            };

            reader.readAsText(file);
        }

        function processContent(text) {
            const urlRegex = /https?:\/\/[a-zA-Z0-9\-\._~:\/?#\[\]@!$&'\(\)*+,;=%]+/g;
            const matches = text.match(urlRegex) || [];
            allMatches = [...new Set(matches)];

            statusMsg.classList.add('hidden');

            if (allMatches.length === 0) {
                alert('未在文件中找到链接');
                return;
            }

            // Show filters and table
            filterContainer.classList.remove('hidden');
            currentPage = 1;
            applyFiltersAndRender();
        }

        function getExtension(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname;
                const parts = pathname.split('.');
                if (parts.length > 1) {
                    return parts.pop().toLowerCase();
                }
            } catch (e) {
                const parts = url.split('.');
                if (parts.length > 1) {
                    let lastPart = parts[parts.length - 1];
                    return lastPart.split(/[?#]/)[0].toLowerCase();
                }
            }
            return '';
        }

        function applyFiltersAndRender() {
            // 1. Filter
            filteredMatches = allMatches.filter(url => {
                const ext = getExtension(url);
                const isImg = IMAGE_EXTS.includes(ext);
                const isVideo = VIDEO_EXTS.includes(ext);

                if (isImg) return filterImg.checked;
                if (isVideo) return filterVideo.checked;
                return filterOther.checked;
            });

            // 2. Sort (Z-A)
            filteredMatches.sort((a, b) => b.localeCompare(a));

            renderTablePage();
        }

        function renderTablePage() {
            resultContainer.classList.remove('hidden');
            resultBody.innerHTML = ''; // Clear existing

            const totalItems = filteredMatches.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE) || 1;

            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
            const pageItems = filteredMatches.slice(startIndex, endIndex);

            // Update Info (Top and Bottom)
            const infoText = `显示 ${startIndex + 1}-${endIndex} (共 ${totalItems} 个链接)`;
            countDisplayTop.textContent = infoText;
            countDisplayBottom.textContent = infoText;

            currentPageSpanTop.textContent = currentPage;
            totalPagesSpanTop.textContent = totalPages;
            currentPageSpanBottom.textContent = currentPage;
            totalPagesSpanBottom.textContent = totalPages;

            // Update Buttons (Top and Bottom)
            const isFirst = currentPage === 1;
            const isLast = currentPage === totalPages || totalPages === 0;

            prevBtnTop.disabled = isFirst;
            nextBtnTop.disabled = isLast;
            prevBtnBottom.disabled = isFirst;
            nextBtnBottom.disabled = isLast;

            const fragment = document.createDocumentFragment();

            pageItems.forEach((url) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';

                const ext = getExtension(url);

                // Preview Cell
                const previewCell = document.createElement('td');
                previewCell.className = 'px-6 py-4 whitespace-nowrap align-middle';

                let previewContent = '<span class="text-gray-400 text-sm italic">无预览</span>';

                if (IMAGE_EXTS.includes(ext)) {
                    previewContent = `<img src="${url}" alt="Preview" class="h-24 w-auto object-cover rounded-lg shadow-sm border border-gray-200 hover:scale-105 transition-transform cursor-pointer" onclick="window.open('${url}', '_blank')">`;
                } else if (VIDEO_EXTS.includes(ext)) {
                    previewContent = `<video src="${url}" controls class="h-24 w-auto rounded-lg shadow-sm border border-gray-200"></video>`;
                }

                previewCell.innerHTML = previewContent;
                row.appendChild(previewCell);

                // Link Cell
                const linkCell = document.createElement('td');
                linkCell.className = 'px-6 py-4 align-middle';

                const linkWrapper = document.createElement('div');
                linkWrapper.className = 'flex flex-col space-y-1';

                const linkText = document.createElement('a');
                linkText.href = url;
                linkText.target = '_blank';
                linkText.className = 'text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium break-all line-clamp-2';
                linkText.textContent = url;
                linkText.title = url;

                linkWrapper.appendChild(linkText);
                linkCell.appendChild(linkWrapper);
                row.appendChild(linkCell);

                fragment.appendChild(row);
            });

            resultBody.appendChild(fragment);
        }
    </script>
</body>

</html>